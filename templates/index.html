<!-- ##> ------ Karthik Sarode : karthik.sarode23@gmail.com - UI for excel files ------ -->
<!DOCTYPE html>
<html>
<head>
    <title>Applied Jobs</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { 
            border-collapse: collapse; 
            width: 100%;
            margin-top: 20px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: left; 
        }
        th { 
            background-color: #f4f4f4; 
            font-weight: bold;
        }
        tr:nth-child(even) { background-color: #f8f8f8; }
        a { 
            color: #0066cc;
            text-decoration: none;
        }
        a:hover { text-decoration: underline; }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .sl-column {
            width: 50px;
            text-align: center;
        }
        .sort-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 5px;
            font-size: 12px;
        }
        .sort-button:hover {
            color: #0066cc;
        }
        .applied-column {
            width: 70px;
            text-align: center;
        }
        .applied-time-column {
            width: 160px;
            text-align: center;
        }
        .tick {
            color: #4CAF50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Applied Jobs History</h1>
        <div class="filters" style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 5px;">
            <label for="easyApplyFilter" style="margin-right: 20px;">
                Easy Apply:
                <select id="easyApplyFilter" style="margin-left: 5px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="all">All</option>
                    <option value="easy">Easy Apply</option>
                    <option value="not-easy">Not Easy Apply</option>
                </select>
            </label>
            <label for="appliedFilter">
                Applied Status:
                <select id="appliedFilter" style="margin-left: 5px; padding: 5px 10px; border: 1px solid #ddd; border-radius: 3px;">
                    <option value="all">All</option>
                    <option value="applied">Applied</option>
                    <option value="pending">Pending</option>
                </select>
            </label>
        </div>
        <table id="jobsTable">
            <thead>
                <tr>
                    <th class="sl-column">Sl No</th>
                    <th>Job Title</th>
                    <th>Company</th>  
                    <th>HR Contact</th>
                    <th>
                        External Link
                        <button class="sort-button" onclick="sortByExternalLink()">↕️</button>
                    </th> 
                    <th class="applied-column">Applied</th>
                    <th class="applied-time-column">Applied Time</th>
                </tr>
            </thead>
            <tbody id="jobsBody"></tbody>
        </table>
    </div>

    <script>
        let sortOrder = 'asc';
        let jobsData = [];
        let filteredJobsData = [];
        let appliedJobs = new Set();

        function formatAppliedTime(value) {
            if (!value || value === 'Pending') {
                return 'Pending';
            }
            const normalized = value.includes('T') ? value : value.replace(' ', 'T');
            const parsed = new Date(normalized);
            if (Number.isNaN(parsed.getTime())) {
                return value;
            }
            const year = parsed.getFullYear();
            const month = String(parsed.getMonth() + 1).padStart(2, '0');
            const day = String(parsed.getDate()).padStart(2, '0');
            const hours = String(parsed.getHours()).padStart(2, '0');
            const minutes = String(parsed.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // Replace the createTableRow function with this updated version
        function createTableRow(job, index) {
            const row = document.createElement('tr');
            
            // Serial Number
            const slCell = document.createElement('td');
            slCell.textContent = index + 1;
            slCell.className = 'sl-column';
            row.appendChild(slCell);
            
            // Job Title with link
            const titleCell = document.createElement('td');
            const titleLink = document.createElement('a');
            titleLink.href = job.Job_Link;
            titleLink.textContent = job.Title;
            titleLink.target = '_blank';
            titleCell.appendChild(titleLink);
            row.appendChild(titleCell);
            
            // Company
            const companyCell = document.createElement('td');
            companyCell.textContent = job.Company;
            row.appendChild(companyCell);
            
            // HR Name with link
            const hrCell = document.createElement('td');
            if (job.HR_Name && job.HR_Name !== 'Unknown') {
                const hrLink = document.createElement('a');
                hrLink.href = job.HR_Link;
                hrLink.textContent = job.HR_Name;
                hrLink.target = '_blank';
                hrCell.appendChild(hrLink);
            } else {
                hrCell.textContent = 'N/A';
            }
            row.appendChild(hrCell);
            
            // External Job Link
            const extCell = document.createElement('td');
            const appliedCell = document.createElement('td');
            appliedCell.className = 'applied-column';
            const appliedTimeCell = document.createElement('td');
            appliedTimeCell.className = 'applied-time-column';

            if (job.External_Job_link === 'Easy Applied') {
                extCell.textContent = 'Easy Applied';
                appliedCell.innerHTML = '<span class="tick">✓</span>';
                appliedTimeCell.textContent = formatAppliedTime(job.Date_Applied);
            } else if (job.External_Job_link) {
                const extLink = document.createElement('a');
                extLink.href = job.External_Job_link;
                extLink.textContent = 'External Link';
                extLink.target = '_blank';
                
                // Add click handler for external link
                extLink.addEventListener('click', async () => {
                    try {
                        const response = await fetch(`/applied-jobs/${job.Job_ID}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const now = new Date();
                            const formatted = formatAppliedTime(now.toISOString());
                            job.Date_Applied = formatted;
                            // Update in both arrays
                            const jobInFiltered = filteredJobsData.find(j => j.Job_ID === job.Job_ID);
                            if (jobInFiltered) {
                                jobInFiltered.Date_Applied = formatted;
                            }
                            // Re-apply filters to update display
                            applyFilters();
                        }
                    } catch (error) {
                        console.error('Error updating applied date:', error);
                    }
                });
                
                extCell.appendChild(extLink);
                // Show tick if already applied
                if (job.Date_Applied !== 'Pending') {
                    appliedCell.innerHTML = '<span class="tick">✓</span>';
                }
                appliedTimeCell.textContent = formatAppliedTime(job.Date_Applied);
            } else {
                extCell.textContent = 'N/A';
                appliedTimeCell.textContent = formatAppliedTime(job.Date_Applied);
            }
            row.appendChild(extCell);
            row.appendChild(appliedCell);
            row.appendChild(appliedTimeCell);
            
            return row;
        }

        function applyFilters() {
            const easyApplyFilter = document.getElementById('easyApplyFilter').value;
            const appliedFilter = document.getElementById('appliedFilter').value;
            
            filteredJobsData = jobsData.filter(job => {
                // Easy Apply filter
                const isEasyApply = job.External_Job_link === 'Easy Applied';
                if (easyApplyFilter === 'easy' && !isEasyApply) return false;
                if (easyApplyFilter === 'not-easy' && isEasyApply) return false;
                
                // Applied status filter
                const isApplied = job.Date_Applied && job.Date_Applied !== 'Pending';
                if (appliedFilter === 'applied' && !isApplied) return false;
                if (appliedFilter === 'pending' && isApplied) return false;
                
                return true;
            });
            
            renderTable();
        }
        
        function renderTable() {
            const tbody = document.getElementById('jobsBody');
            tbody.innerHTML = '';
            filteredJobsData.forEach((job, index) => {
                tbody.appendChild(createTableRow(job, index));
            });
        }

        function sortByExternalLink() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            
            filteredJobsData.sort((a, b) => {
                const valueA = a.External_Job_link || '';
                const valueB = b.External_Job_link || '';
                
                if (sortOrder === 'asc') {
                    return valueA.localeCompare(valueB);
                } else {
                    return valueB.localeCompare(valueA);
                }
            });
            
            renderTable();
        }

        // Add event listeners for filters
        document.getElementById('easyApplyFilter').addEventListener('change', applyFilters);
        document.getElementById('appliedFilter').addEventListener('change', applyFilters);

        fetch('http://localhost:5000/applied-jobs')
            .then(response => response.json())
            .then(jobs => {
                jobsData = jobs;
                filteredJobsData = jobs;
                applyFilters();
            })
            .catch(error => console.error('Error:', error));
    </script>
</body>
</html>

<!-- ##< -->
